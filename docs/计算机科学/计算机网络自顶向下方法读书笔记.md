# 1 计算机网络和因特网

因特网是有史以来由人类创造、精心设计的最大系统，具有数以亿计相连的计算机、通信链路和交换机，有数十亿使用编写计算机、平板电脑和智能手机的用户，还有一批与因特网连接点信息设备，如传感器、Web摄像机、游戏机、相框甚至洗衣机。

面对如此巨大并且具有如此众多不同组件和用户的因特网，是否能理解它的工作原理？是否存在某些指导原则和结构，能够作为理解规模和复杂程度惊人的系统的基础？

# 1.1 什么是因特网

对因特网的两种描述：

### 1.1.1 具体构成描述

描述因特网的具体构成，包括基本硬件和软件组件：

+ 主机（host）/端系统（end system）

+ 因特网服务提供商（Internet Service Provider）

  + 通信链路（communication link）
  + 分组交换机（packet switch）/路由器（Router）/链路层交换机（Link-Layer Switch）

 + 协议（Protocol，TCP/IP）

因特网工程任务组（IETF）/请求评论（RFC）。

### 1.1.2 服务描述

描述因特网为应用程序提供服务的基础设施，包括应用服务和应用程序编程接口（API）：

+ 因特网应用程序运行在端系统上（分布式应用程序），涉及多台相互交换数据的端系统；

+ 应用程序编程接口规定了运行在一个端系统上的软件请求因特网基础设施向运行在另一个端系统上的特定目的软件交付数据的方式；

### 1.1.3 什么是协议

协议定义了在两个或多个通信实体间交换的报文格式和顺序，以及报文发送和/或接收一条报文或其他事件所采取的动作。

因特网/计算机网络广泛地使用了协议，不同的协议用于完成不同的通信任务。

## 1.2 网络边缘

不久以前，与因特网相连的端系统设备主要还是传统的计算机，如桌面机和服务器；越来越多的设备具有接受和发送数字数据的特性、通过网络连接在一起，因特网变成物联网。

### 1.2.1 接入网

接入网（access network）：指将端系统连接到边缘路由器（edge router）的物理链路；

边缘路由器：端系统到任何其他远程端系统的路径上的第一台路由器。

接入方案：

+ 家庭接入：DSL、电缆、FTTH/PON、拨号和卫星

+ 企业（和家庭）接入：以太网和WIFI

+ 广域无线接入：4G/5G

### 1.2.2 物理媒体

物理媒体分为两类：

+ 导引型媒体（guided media）：电波沿着固体媒体前进，如光缆、双绞铜线或同轴电缆
+ 非导引型媒体（unguided media）：电波在空气或外层空间传播，包括陆地无线电信道和卫星无线电信道

## 1.3 网络核心

### 1.3.1 分组交换

在网络中，端系统彼此交换报文（message）。报文可以执行一种控制功能，也可以包含数据。为了从源端系统向目的端系统发送一个报文，源端将长报文划分为较小的数据库，称之为分组（packet）。

+ 存储转发机制：
  + 交换机在开始向输出链路传输该分组的第一个比特之前，必须接受到整个分组；
  + 单路由器转发时延是L/R，链路时延是NL/R；

+ 排队时延和分组丢失
  + 分组交换机的输出链路具有输出缓存（output queue），如果到达的分组需要传输到某链路、但该链路正忙于传输其他分组，则该分组需要在输出缓存中等待；
  + 输出缓存引入排队时延（queue delay），排队使用取决于网络的拥塞程度；
  + 输出缓存长度有限，网络拥塞可能导致分组丢失（packet lost）；

+ 转发表和路由选择协议
  + 每个端系统具有一个IP地址，IP分组包含了目的地的IP地址；
  + 路由器检测分组的目的地址，通过转发表（forwarding table）将目的地在映射为输出链路，并向相邻路由器转发分组；
  + 路由选择协议（routing protocol）用于自动设置路由路径；

### 1.3.2 电路交换

在电路交换网络中，在端系统间通信会话期间，预留了端系统见通信沿路径所需要的资源（缓存、链路传输速率）；在分组交换网络中，这些资源不是预留的，会话的报文按需使用资源，其后果可能是不得不排队接入通信线路。

电路交换网络中的复用：频分复用（FDM）vs时分复用（TDM）

分组交换与电路交换的对比：

+ 电路交换在静默期（silent period）专用电路空闲而效率较低；

+ 分组交换的端到端时延可变且不可预测（批评者认为不适合实时服务）；

+ 分组交换的优点：更好的带宽共享、更简单、更便宜；

分组交换和电路交换在今天的电信网络中都是普遍采用的方式，但趋势向分组交换迁移。

### 1.3.3 网络的网络

端系统通过接入ISP与因特网相连，接入ISP自身必须互联（使所有的端系统能够彼此发送分组）。

构成因特网的”网络的网络“已经演化成为一个非常复杂的结构，这种演化大部分是由经济和国家策略驱动的，而不是性能考虑驱动的：

+ 结构1：单一的全球承载ISP互联所有接入ISP，接入ISP向全球承载ISP付费；
+ 结构2：数十万个接入ISP和多个彼此互联的全球承载ISP，接入ISP可以根据价格和服务选择全球承载ISP；
+ 结构3：接入ISP、区域ISP（可能有多级）和全球承载ISP三级结构；
+ 结构4：结构3 + PoP、多宿、对等和IXP（因特网交换点）组成；
+ 结构5：结构4 + CDN（内容提供商网络）；

今天的因特网是一个网络的网络，结构复杂，由十多个第一层ISP和数十万个较低层ISP组成。

## 1.4 分组交换网中的时延、丢包和吞吐量

### 1.4.1 分组交换网中的时延

节点总时延（total nodal delay）：

+ 节点处理时延（nodal processing delay）

+ 排队时延（queuing delay）

+ 传输时延（transmission delay）

+ 传播时延（propagation delay）

### 1.4.2 排队时延和丢包

结点时延中最复杂和有趣的成分是排队时延。排队时延取决于流量到达该队列的速率、链路的传输速率和到达流量的性质。

流量强度（traffic intensity）：La/R。设计系统时流量强度要小于1。随着流量强度接近于1，平均排队时延迅速增加。

丢包：由于链路的缓存队列长度有限，缓存队列满了以后，新到达的分组被迫丢弃。

### 1.4.3 端到端时延

端到端时延是各节点时延累加的总时延。

其他时延：应用程序的时延、媒体分组化时延等。

### 1.4.4 计算机网络中的吞吐量

瞬时吞吐量（instantaneous throughput）

平均吞吐量（average throughput）

瓶颈链路（bottleneck link）

## 1.5 协议层次及其服务模型

### 1.5.1 分层的体系结构

网络设计者以分层（layer）的方式组织协议、每层向上层提供服务，一个协议层用软件、硬件或结合实现。

各层的所有协议称之为协议栈：

+ 因特网协议栈：应用层（报文message）、传输层（报文段segment）、网络层（数据包datagram）、链路层（帧frame）和物理层；
+ OSI参考模型：应用层、表示层、会话层、传输层、网络层、链路层和物理层；

### 1.5.2 封装

封装（encapsulation）：分组包括包头和有效载荷字段（来自上一层的分组）。

## 1.6 面对攻击的网络

网络安全领域主要讨论下列问题：坏家伙如何攻击计算机网络，如何防御其攻击、设计能够事先免除这样攻击的新型体系结构。

今天最流行的攻击类型：

+ 恶意程序（malware）
  + 多数是自我复制的，包括病毒（virus，需要用户交互）和蠕虫（worm，无需用户交互）两类
  + 受害主机被称为僵尸网络（botnet）

+ 拒绝服务攻击（DoS）和分布式拒绝服务攻击（DDoS ）
  + 弱点攻击：向一个目标主机上运行的易受攻击的应用程序或操作系统发送制作精细的报文，造成服务器停止运行或主机崩溃；
  + 带宽洪泛：攻击者向目标主机发送大量的分组，分组数量之多使得目标的接入链路变得拥塞，使得合法的分组无法到达服务器；
  + 连接洪泛：攻击者在目标主机中创建大量的半开或全开TCP连接，该主机因这些伪造的连接而陷入困境，并停止接受合法的连接；

+ 嗅探分组：在无线或有线环境中，通过分组嗅探得到传输内容的副本；
+ 伪装成你信任的人：生成具有任意源地址、分组内容和目的地址的分组，并将其注入到因特网中传输，伪装成其他用户
  + 起因：因特网是基于“一群相互信任的用户连接到一个透明的网络上”的模型进行设计的；
  + 应对：端点鉴别技术，使我们能够确信一个报文源自确认的地方；



## 1.7 计算机网络和因特网的历史

分组交换的发展：1961-1972

专用网络和网络互联：1972-1980

网络的激增：1980-1990

因特网爆炸：20世纪90年代

# 2 应用层

本章讲述有关网络应用的原理和实现方面的知识：

+ 定义几个关键的应用层概念开始，包括应用程序所需要的网络服务、客户和服务器、进程和传输层接口；
+ 考察几种网络应用程序，包括Web、电子邮件、DNS和对等文件分发；
+ 开发运行在TCP和UDP上的网络应用程序，学习套接字API，学习用Python写的CS应用程序；

## 2.1 应用层协议原理

研制网络应用程序的核心是写出能够在不同的端系统和通过网络彼此通信的程序，需要编写将在多台端系统上运行的软件（C/Java/Python）。

### 2.1.1 网络应用程序体系结构

+ 客户-服务器体系结构（CS）
  + 有一个总是打开的主机称为服务器，为多个客户的主机请求服务，该服务器具有固定的、周知的IP地址；
  + 单一服务器主机跟不上所有客户请求，配置大量主机的数据中心被用于创建强大的虚拟服务器；

+ 对等体系结构（P2P）
  + 应用程序在间断连接的主机对之间直接连接，对数据中心的专用服务器具有最小依赖；
  + 优点是自扩展性，对服务器基础设施和带宽需求小，成本优势；
  + 挑战包括ISP友好、安全性和激励；

### 2.1.2 进程通信

在操作系统的术语中，进行通信的是进程（process）

+ 进程运行在相同的端系统上，使用进程间通信机制相互通信；
+ 进程运行在不同端系统上，通过跨越计算机网络交换报文（message）相互通信；

客户和服务器进程：网络应用程序由成对的进程组成，发起方被标识为客户，在会话开始时等待联系的进程是服务器。

进程通过套接字（socket）的软件接口向网络收发报文。套接字是建立网络应用程序的可编程接口，也被称为应用程序编程接口（API）。

一台主机上运行的进程向另一台主机上运行的进程发送分组，需要进程寻址。因特网采用的是IP地址+端口号的方案。

### 2.1.3 可供应用程序使用的传输服务

因特网提供了多种传输层协议，通过研究可用的传输层协议所提供的服务，选择最合适的协议。从四个方面对应用程序服务要求进行分类：

+ 可控数据传输

+ 吞吐量

+ 实时性

+ 安全性

### 2.1.4 因特网提供的传输服务

**TCP服务**

+ 面向连接的服务

+ 可靠的数据传输服务

+ 拥塞控制机制

TCP或UDP没有提供加密机制，传输内容可能在中间链路被嗅探和发现。安全套接字层（Secure Sockets Layer， SSL）可以提供关键的进程到进程的安全性服务，包括加密、数据完整性和端点鉴别。SSL是一种对TCP的价钱，通过应用层实现。

**UDP服务**

+ 无连接服务

+ 轻量级传输协议

+ 无拥塞控制机制

TCP/UDP不提供对吞吐量或定时保证。今天的因特网通常能够为时间敏感应用提供满意的服务，但不提供任何定时或带宽保证。

### 2.1.5 应用层协议

应用层协议（application-layer protocol）定义了运行在不同端系统上的应用程序进程如何相互传递报文，包括：

+ 交换的报文类型，例如请求报文和响应报文；

+ 各种报文类型的语法，如报文中各个字段及其描述；
+ 字段的语言，即个字的中包含的信息含义；
+ 一个进程何时以及如何发送报文，对报文进行响应的规则；

网络应用与应用层协议：后者只是前者的一部分。

### 2.1.6 本文涉及的网络应用

5种重要的应用：

+ Web
+ 文件传输
+ 电子邮件
+ 目录服务
+ P2P

## 2.2 Web和HTTP

20世纪90年代之前，因特网主要使用者是研究人员、学者和大学生，使用方法是登录远程主机、传输文件、收发新闻和电子邮件。90年初期万维网应用引起公共注意，极大地改变了人们与工作环境内外交流的方式，将因特网从众多数据网之一的地位提升为仅有的一个数据网。

### 2.2.1 HTTP概况

Web的应用层协议是超文本传输协议（HTTP），是Web的核心，在RFC 1945 和RFC 2616中定义。HTTP由客户程序和服务器程序实现，两者运行在不同的端系统中，通过交换HTTP报文进行会话。

Web页面由对象（object）组成，一个对象是一个文件（HTML文件、JPEG图形、Java程序或视频片段），可以通过一个URL地址寻找。每个URL地址由两部分组成：存放对象的服务器主机名和对象的路径名。Web服务器实现了HTTP的服务器端，用于存储Web对象。流行的Web服务器包括Apache和IIS。

HTTP定义了Web客户端向服务器请求页面及服务器向客户端传输页面的方式。当用户请求一个Web页面时，浏览器向服务器发出请求页面对象的HTTP请求报文，服务器接收到请求并用包含对象的HTTP报文进行响应。

HTTP使用TCP作为支撑运输协议。HTTP客户端首先发起一个与服务器的TCP连接，当连接建立后，该浏览器和服务器进程可以通过套接字接口访问TCP。分层体系结构的优点：HTTP协议不担心数据丢失，也不关注TCP从网络的数据丢失和乱序故障中恢复的细节，那是TCP及协议栈较低层协议的工作。

HTTP是一个无状态协议：服务器向客户发送被请求的文件，而不存储任何关于该客户的状态信息。

### 2.2.2 非持续连接和持续连接

客户端和服务器的两种通信机制：

+ 非持续连接：每个请求/响应对由单独的TCP连接发送；

+ 持续连接：每个请求/响应对由不同的TCP连接发送；

往返时间（RTT）：一个短分组从客户端到服务器再返回客户端所需要的时间，包括分组传播时延、分组在中间路由器和交换机上排队时延及分组处理时延。一次请求响应时间是两个RTT加上服务器传输HTML文件的时间。

非持续连接的缺点：每个请求对象建立和维护独立的TCP，系统开销大；每个对象经受两倍RTT交付时延。HTTP的默认模式是使用带流水的持续连接。

### 2.2.3 HTTP报文格式

请求报文：

> GET /somedir/page.html 	HTTP/1.1
>
> Host: www.someschool.edu
>
> Connection: close
>
> User-agent: Mozilla/5.0
>
> Accept-language: fr
>

说明：

+ 基于ASCII码书写；
+ 请求行包括三个字段：方法字段（GET/POST/HEAD/PUT/DELETE）、URL字段和HTTP版本字段；
+ 首部行指向请求对象所在主机，是Web带来缓存所需要；
+ 实体主体：使用GET方法时为空，使用POST方法时提供内容；

响应报文：

> HTTP/1.1 200 OK 
>
> Connection: close
>
> Date: Tue, 09 Aug 2011 15:44:04 GMT
>
> Server: Apache/2.2.3 (CentOS)
>
> Last-Modified: Tue, 09 Aug 2011 15:11:03 GMT 
>
> Content-Length: 6821
>
> Content-Type: text/html
>

常用的状态码和相关短游：

+ 200 Okay：请求成功；
+ 301 Moved Permanently：请求对象已经被永久转移了；
+ 400 Bad Request：通用差错代码，该请求不能被服务器理解；
+ 404 Not Found: 被请求的文档不在服务器；
+ 505 HTTP Version Not Supported：服务器不支持请求报文使用的HTTP协议版本；

### 2.2.4 用户与服务器的交互：cookie

HTTP服务器是无状态的，这简化了服务器的设计，并允许同时处理数以千计TCP连接的高性能Web服务器。然而Web站点通常希望能够识别用户，希望把内容与用户身份联系起来，或者限制用户的访问。因此，HTTP使用了cookie，允许站点对用户进行跟踪。

cookie有4个组件：

+ HTTP响应报文中有一个cookie首部行；
+ HTTP请求报文中有一个cookie首部行；
+ 用户端系统中保留有一个cookie文件，由用户的浏览器进行管理；
+ Web站点有一个后端数据库；

cookie作用流程：

+ 客户端浏览器访问Web服务器，web站点产生一个唯一识别码，并以此作为索引在后端数据库产生一个表项；
+ Web服务器用一个包含Set-cookie：首部的HTTP响应报文对浏览器进行响应（包含该识别码）；
+ 浏览器收到该HTTP响应报文，看到Set-cookie：首部，浏览器在其管理的特定cookie文件中添加一行，包含服务器主机名和识别码；
+ 浏览器继续访问Web服务器，每个页面请求时浏览器都从该cookie文件中获取网站识别码，并放到HTTP请求报文中包含识别码的cookie首部行中；
+ Web服务器可以跟踪浏览器在Web站点访问记录；
+ 浏览器再次访问该Web服务器，会在请求报文中继续放入首部行cookie，则Web服务器可以在数据库中获取其用户信息，将其全名与识别码相关联；

cookie可以简化用户的因特网购物活动，但使用有争议，被认为对用户隐私的侵害。

### 2.2.5 Web缓存

Web缓存器（Web cache）也叫代理服务器（proxy server），能够代表初始Web服务器来满足HTTP请求。Web缓存器有自己的磁盘存储空间，并在存储空间中保持最近请求过的对象副本。

Web缓存器通常由ISP购买并安装。优点：

+ 大大减少对客户请求的响应时间，特别是客户与初始服务器之间瓶颈带宽远低于与Web缓存器之间瓶颈带宽时；
+ 大大减少一个机构接入链路到因特网的通信量，降低费用；
+ 大大减少因特网上的Web流量，改善所有应用的性能；

通过使用内容分发网络（CDN, Content Distribution Network），Web缓存器正在因特网中发挥着越来越重要的作用。

### 2.2.6 条件GET方法

高速缓存能减少用户感受到的响应时间，但引入问题：存放在缓存器中的对象副本可能是陈旧的。HTTP协议通过条件GET机制允许缓存器证实其对象是最新的：

+ 请求报文使用GET方法；
+ 请求报文中包含“If-Modified-Since：”首部行；

## 2.3 FTP

在典型的FTP辉煌中，用户在本地主机向远程主机传输文件。为使用户能访问其远程账户，用户需要提供其用户标识和口令，建立TCP连接。

HTTP与FTP都是文件传输协议，都运行在TCP协议上。HTTP采用带内控制信道，FTP使用了两个并行的TCP连接来传输文件：

+ 控制连接（control connection）：传输控制信息，包括用户标识、口令、改变目录及存放和获取文件的命令；

+ 数据连接（data connection）：实际发送文件；

## 2.4 电子邮件

电子邮件是一种异步通信媒介，快速并且易于分发。现代电子邮件具有许多强大的特性，包括具有附件、超链接、HTML格式文本和图片的报文。

因特网电子邮件系统的三个主要组成部分：

+ 用户代理（user agent）；
+ 邮件服务器（mail server）；
+ 简单邮件传输协议（SMTP，Simple Mail Transfer Protocol）。

### 2.4.1 SMTP

SMTP（RFC 5321）是因特网电子邮件中主要的应用层协议，用于从发送方的邮件服务器发报文到接收方的邮件服务器，使用TCP可靠数据传输服务。

SMTP协议流程：

+ 客户SMTP（发送邮件服务器）在25号端口建立一个到服务器SMTP（接受邮件服务器）上的TCP连接（如果服务器未开机则稍后尝试连接）；
+ 连接建立，客户SMTP与服务器SMTP进行握手连接，指示发送方和接收方邮件地址；
+ 客户发送报文，投递邮件到接收服务器；；
+ 接收方从接收服务器上收取邮件，进行阅读和处理；

### 2.4.2 与HTTP的对比

相同：

+ 两个协议都用于从一台主机向另一台主机传输文件；
+ 文件传输时都使用持续连接；

区别：

+ HTTP是拉协议（pull protocol），SMTP是推协议（push protocol）；

+ SMTP使用7bit ASCII码格式，HTTP数据无此限制；

+ SMTP把所有报文对象放在一个报文中，HTTP把每个对象封装在自己的HTTP响应报文中；

### 2.4.3 邮件报文格式和MIME

RFC 5322 定义了邮件首部行及其语义解释格式。典型的首部行包括：

> From: alice@crepes.fr
>
> To: bob@hamburger.edu
>
> Subject: Searching for the meaning of life.

### 2.4.4 邮件访问协议

SMTP（推协议）用于将邮件从发送方的用户代理传输到发送方的邮件服务器，及从发送方的邮件服务器到接收方的邮件服务器。通过POP3等拉协议从接收方的邮件服务器传送到接收方的邮件代理：

**POP3**（RFC 1939）

用户代理打开一个到邮件服务器端口110上的TCP连接后，POP3安装三个阶段进行工作：

+ 特许（authorization）：用户代理发送明文用户名和口令鉴别用户；
+ 事物处理：用户代理取回报文，以及相关操作（删除标志处理及获取邮件统计信息）；
+ 更新阶段：结束POP3会话，邮件服务器删除被标志的报文；

**IMAP** （RFC 3501）

POP3不能在远程服务器上创建文件夹，IMAP把服务器上每个报文与一个文件夹联系起来，并提供了创建文件夹和移动邮件的命令，包括远程查询邮件。IMAP服务器维护了进行IMAP会话的用户状态信息，另一个特性是允许用户代理获取报文组件的命令。

**基于Web的电子邮件**

通过HTTP进行邮件访问。

## 2.5 DNS：因特网的目录服务

识别主机的两种方式：主机名或者IP地址。

### 2.5.1 DNS提供的服务

DNS（RFC 1034/1035）

+ 一个由分层的DNS服务器实现的分布式数据库；
+ 一个使得主机能够查询分布式数据库的应用层协议；

DNS功能：

+ 主机名与IP地址的转换；

+ 主机别名（host aliasing）；

+ 邮件服务器别名（mail server aliasing）；

+ 负载分配（load distribution）；

### 2.5.2 DNS工作机理概述

DNS协议流程：

+ 用户主机上的应用程序调用DNS客户端，指明需要被转换的主机名（gethostbyname()）；
+ 客户端向网络发送DNS查询报文（UDP数据报@端口53）；
+ 客户端收到DNS回答报文；

从用户主机上调用程序的角度看，DNS是一个提供直接转换服务的黑盒子，由分布于全球的大量DNS服务器及DNS应用层协议组成。

+ 分布式、层次数据库
  + 根DNS服务器
  + 顶级域（TLD） DNS服务器（面向领域（com, org））
  + 权威DNS服务器（面向组织机构）
  + 本地DNS服务器

+ DNS缓存：改善时延并减少DNS报文数量

### 2.5.3 DNS记录和报文

DNS记录（RR，Resource Record）：

+ 提供了主机名到IP地址的映射；
+ 四元组（Name, Value, Type, TTL）；

DNS报文：

+ 查询和回答报文格式相同；

+ 报文结构：首部、问题、回答、权威和附加；

DNS数据库增加记录：

+ 注册域名时，需要提供基本和辅助权威DNS服务器名字和IP地址；

+ 注册登记机构确保将一个类型NS和一个类型A的记录输入TLD服务器；

### 2.5.4 DNS脆弱性

DNS是因特网基础设施的关键部件，可能的攻击方法：

+ DDoS带宽洪泛攻击；

+ 中间人伪造攻击；
+ DNS反射攻击；

## 2.6 P2P应用

客户服务器体系架构依赖于基础设施服务器，P2P体系架构彼此直接通信、不依赖于基础设施。

### 2.6.1 P2P文件分发

P2P体系结构的最小分发时间小于CS结构，并且对于任意对等方数量N，总是小于F/u。P2P体系结构是自扩展的，对等方不但是比特的消费者还是重新分发者。

BitTorrent是一种用于文件分发的P2P协议：

+ 参与文件分发的所有对等方集合为一个*洪流*（torrent）；
+ 洪流中对等方下载等长度的文件块（chunk），典型块长度为256KB；
+ 每个洪流中有一个基础设施节点（追踪器），新的对等方加入洪流时，向追踪器注册并周期性通知；
+ 新的对等方加入洪流时，追踪器随机选择提供对等方子集，新加入与子集中的对等方建立TCP连接，传输文件块；
+ 两个问题：
  + 从邻居请求哪些文件块：最稀缺优先机制；
  + 向那些请求块的领军发送：交换的激励机制（tit-for-tat）；

### 2.6.2 分布式散列表

分布式散列表（DHT, Distributed Hash Table）：

+ 在数以百万计的对等方上存储键值对，每个对等方的键值对仅占总体的一个小子集；
+ 任意对等方允许查询键值对或插入新对；

## 2.7 TCP套接字编程

典型的网络应用是由一对程序组成的，位于不同的端系统中。客户进程和服务器进程通过套接字读出和写入数据彼此进行通信。

## 2.8 小结



# 3 传输层

传输层位于应用层和网络层之间，为运行在不同主机上的应用进程提供直接的通信服务。

两个关键功能：

+ 如何才能在一种会丢失或损坏数据的媒体上可靠地通信，建立起一套被传输协议用例解决问题的技术、并体现在TCP协议中；

+ 控制传输层实体的传输速率以避免网络中的拥塞，或从拥塞中恢复。研究拥塞的原因和后果，以及常用的拥塞控制技术；

## 3.1 概述和传输层服务

传输层协议为运行在不同主机上的应用进程提供了逻辑通信（logic communication）功能：

+ 从应用程序的角度看，通过逻辑通信，运行不同进程的主机好像直接相连；传输层协议在端系统中而不是在路由器中实现；
+ 应用进程使用传输层提供的逻辑通信功能彼此发送报文，而无需考虑承载实现。

两种传输层协议：TCP（可靠的、面向连接的服务）和UDP（不可靠、无连接的服务）。

### 3.1.1 传输层和网络层的关系

+ 网络层提供了主机之间的逻辑通信；
+ 传输层为运行在不同主机上的进程之间提供了逻辑通信；

### 3.1.2 因特网传输层概述

因特网的网络层采用IP协议（网际协议），为主机之间提供逻辑通信。IP是尽力而为交付（best-effort delivery service），尽其最大努力在通信的主机之间交付报文段，但不做任何担保（不确保报文段的交付、不保证报文段的按序交付、不保证报文段中数据的完整性）。

传输层协议（UDP/TCP）将两个端系统之间IP的交付服务扩展为运行在端系统上的两个进程之间的交付服务：

+ 传输层的多路复用与多路分解；
+ 报文的差错检测和完整性检查；
+ 可靠数据传输；
+ 拥塞控制；

## 3.2 多路复用与多路分解

一个进程有一个或多个套接字（socket），相当于从网络向进程传输数据和从进程向网络传递数据的门户：

+ 多路分解（demultiplexing）：在主机上的每个套接字能够分配一个端口号，当报文段到达主机是，传输层检查报文段中的目的端口号，并将其定向到对应的套接字，报文段中的数据通过套接字进入到所连接的进程；

+ 多路复用：在源主机从不同套接字中收集数据库，并为每个数据块封装上报头、生成报文段，并将报文段传递到网络层；

套接字的标识：源端口号字段+目的端口号字段

**无连接的多路复用与多路分解**

创建UDP套接字，传输层自动为该套接字分配一个端口号（1024～65535）。如果应用程序实现的是一个“周知协议”的服务器端，则开发者需要为其分配一个相应的周知端口号。

> clientSocket = socket(socket.AF_INET, socket.SOCK_DGRAM)

一个UDP套接字是由一个二元组（目的IP地址+目的端口号）来全面标识的，包括应用程序数据、源端口号、目的端口号和其他两个值。

**面向连接的多路复用与多路分解**

TCP套接字是由一个四元组（源IP地址、源端口号、目的IP地址和目的端口号）来表示的。服务器主机可以支持多个并行的TCP套接字，并由其四元组来表示每个套接字。当一个TCP报文段到达主机时，所有四个字段用来将报文段定向（分解）到对应的套接字。

## 3.3 无连接传输：UDP

由RFC 768定义的UDP只是做了传输协议能够做的最少工作。除了复用/分解功能及少量的差错检测外，几乎没有对IP增加别的东西：

+ UDP从应用程序得到数据，附加上用于多路复用/分解服务的源和目的端口号字段，形成报文段交给网络层；

+ 网络层将该传输层报文段封装到IP数据报中，通过尽力而为地尝试交付给接收主机；

+ 接收主机的UDP使用端口号将报文段的数据交付给正确的应用进程；

UDP相对于TCP的优势：

+ 关于何时、发送什么数据的应用层控制更为精细。TCP有拥塞控制机制、UDP直接发送；

+ 无需连接建立。TCP三次握手、UDP直接发送；
+ 无连接状态；TCP需要在端系统中维持连接状态，包括接收和发送缓存、拥塞控制参数及序列号和确认号；
+ 分组报头开销小。UDP报头8Byte vs TCP报头20Byte；

电子邮件、远程终端访问、Web及文件传输运行在TCP之上（需要TCP的可靠数据传输），路由选择表更新（RIP）及网络管理数据成长（SNMP）承载于UDP。

**UDP报文段结构**：源端口号（2B）+目的端口号（2B）+长度（2B）+校验和（2B）+应用数据（报文）

**UDP校验和**：报文内容校验和，提供差错检测机制

## 3.4 可靠数据传输原理

可靠数据传输协议：为上层实体提供一条可靠的信道进行传输，确保所有传输数据比特不会受到损坏或丢失，而且所有数据按照其发送顺序进行交付。

### 3.4.1 构造可靠数据传输协议

+ 经完全可靠信道的可靠数据传输（1.0）：所有分组从发送方留下接收方，无反馈信息；
+ 经具有比特差错信道的可靠数据传输（2.0）：
  + 自动重传请求ARQ
  + 差错检测（检验和）
  + 接收方反馈（序号及ACK分组）
  + 重传

+ 经具有比特差错的丢包信道的可靠数据传输（3.0）：
  + 肯定和否定确认分组
  + 倒计数定时器

### 3.4.2 流水线可靠数据传输协议

rdh3.0是一个功能正确的协议，但性能存在问题，核心在于它是一个停等协议，信道利用率低（Ts/(Ts+2×RTT））。

改进方法：流水线技术，通过GBN（回退N步）和SR（选择重传）。

### 3.4.3 可靠数据传输机制小结

+ 校验和：用于检测在一个传输分组中的比特错误；

+ 定时器：用于超时/重传一个分组，可能因为该分组（或其ACK）在信道中丢失了；
+ 序号：用于为从发送方流向接收方的数据分组按顺序编号，可以使接收方检测出丢失的分组，和分组的冗余副本；
+ 确认：接收方用于告诉发送方一个分组或一组分组被正确接收到了，通常携带分组的序号；
+ 否定确认：接收方用于告诉发送方某个分组未被正确接收；
+ 窗口/流水线：发送方被限制仅发送序号落在一个指定范围内的分组；

## 3.5 面向连接的传输：TCP

TCP是因特网传输层的面向连接的可靠传输协议，采用了多种安全机制，包括差错检测、重传、累积确认、定时器以及用于序号和确认号的报头信息。

### 3.5.1 TCP连接

1974年4月，Vinton Cerf和Robert Kahn在《IEEE Transactions on Communications Technology》上发表TCP/IP协议论文。TCP/IP 是当今因特网的支柱性协议，Cerf和Kahn看到了对联网协议的需求，一方面为行将定义的应用提供广泛的支持，另一方面允许任何主机与链路层协议互操作。

TCP是面向连接的，在一个应用进程可以开始向另一个应用进程发送数据之前，两个进程必须先互相握手，发送某些预备报文段，建立确保数据传输的参数，初始化TCP连接的状态变量。TCP连接的组成包括：一台主机上的缓存、变量和与进程连接的套接字，以及另一台主机上的缓存、变量和套接字。

### 3.5.2 TCP报文段结构

TCP报文段由报头字段（20Byte）和数据字段组成，报头字段：

+ 源端口号（2B）+目的端口号（2B）
+ 序号（4B）+确认号（4B）
+ 报头长度（4b）+可选字段（6b）+标识字段（6b，ACK，RST，PSH，SYN，FIN，URG）
+ 接受窗口（2B）+因特网校验和（2B）+紧急数据指针（2B）（紧急数据指针和PSH及URG没有使用）
+ 选项（4B）+数据（nB）

### 3.5.3 往返时间的估计与超时

TCP采用超时/重传机制来处理报文段的丢失，一个明显的问题是超时间隔长度的设置。

**估计往返时间**：TCP定时测量SampleRTT，并更新估计EstimatedRTT

EstimatedRTT = （1-alpha) * EstimatedRTT + aplha * SampleRTT

DevRTT = (1 - betaRTT) * DevRTT + beta * |SampleRTT - EstimatedRTT|

**设置和管理重传超时间隔**

TimeOutInterval = EstimatedRTT+ 4* DevRTT 

TCP通过使用肯定确认与定时器来提供可靠数据传输。TCP确认正确接收到的数据，而当任务报文段或其确认报文丢失或受损时，TCP会重传这些报文段。有些版本的TCP还有一个隐式NAK机制，在TCP的快速重传机制下，接收到对一个特定报文段的3个冗余ACk就可作为后面报文段的一个隐式NAK，从而在超时之前触发对该报文段的重传。

### 3.5.4 可靠数据传输

TCP在IP不可靠的尽力而为服务之上创建了一个可靠数据传输服务，确保一个进程从其接收缓存中读出的数据流是无损坏、无间隔、无冗余和按序的数据流。

一个简化的模型描述包括：

+ 从上层应用接收数据，封装到一个报文段中，并交给IP，并启动定时器；

+ 定时器超时，TCP通过重传引起超时的报文段来响应超时时间，重启定时器；
+ 接收方确认报文段到达，TCP将ACK的序号与SendBase进行比较，如果当前有未被确认的报文段，TCP重启定时器；

### 3.5.5 流量控制

TCP连接在两侧主机都设置了接收缓存。当该TCP连接接收到正确按序的字节后，将数据放入缓存。如果某应用程序读取数据时相对缓慢，而发送方发送的太快太多，发送的数据容易造成连接的接收缓存溢出。

TCP通过两个机制来控制：

+ 流量控制：是一个速率匹配服务，发送方的发送速率与接收方应用程序的读取速率相匹配；
+ 拥塞控制：TCP发送方由于IP网络拥塞而进行的发送控制；

TCP通过让发送方为何一个接收窗口（receive window）的变量来提供流量控制：

+ 发送方：LastByteRcvd - LastByteRead <= RcvBuffer

+ 接收方：LastByteSend - LastByteAcked <= rwnd

### 3.5.6 TCP连接管理

三次握手建立TCP连接：

+ 客户端TCP向服务器端TCP发SYN报文段；
+ 服务器端提前TCP SYN报文段，分配TCP缓存和变量，发送SYN ACK报文段；
+ 客户端分配缓存和变量，发送应答报文；

四次挥手关闭TCP连接：

**客户端经历的TCP状态序列**

CLOSED（发起建立连接，发送SYN） -> SYN_SENT（接收SYN & ACK，发送ACK ）-> ESTABLISHED （发起关闭连接，发送FIN）-> FIN_WAIT_1（接收ACK）->FIN_WAIT_2（接收FIN，发送ACK）->TIME_WAIT（等待30秒）->CLOSED

**服务器端经历的TCP状态序列**

CLOSED（服务器应用程序创建一个监听套接字）-> LISTEN （接收SYN并发送SYN & ACK）-> SYN_RCVD（接收ACK，不发送）-> ESTABLISHED（接收FIN，发送ACK）-> CLOSEN_WAIT（发送FIN）-> LAST_ACK（接收ACK，不发送）-> CLOSED

## 3.6 拥塞控制原理

在实践中，分组丢失（丢包）一般是由于网络变得拥塞时由路由器溢出引起的。分组重传作为网络拥塞的征兆来对待，但是无法处理导致拥塞的原因，因为有太多的源想以过高的塑料发送数据。为了处理网络拥塞，需要一些机制以致面临网络拥塞时遏制发送方。

### 3.6.1 拥塞原因及代价

+ 情况1：两个发送方和一台具有无穷大缓存的路由器
  + 吞吐速率：R/2
  + 时延：指数增长

+ 情况2：两个发送方和一台具有有限缓存的路由器
  + 吞吐速率：R/3（一个分组丢失才重传）vs R/4（发送方超时重传在队列中已被推迟但未丢失的分组）

+ 情况3：四个发送方和具有有限缓存的多台路由器及多跳路径
  + 吞吐速率曲线
  + 拥塞代价：一个分组沿一条路径被丢弃时，每个上游路由器用于转发该分组而使用的传说容量被浪费

### 3.6.2 拥塞控制方法

+ 端到端拥塞控制：端系统通过对网络行为的观察来推断拥塞，可以通过增加往返时延值作为网络拥塞程度指示
+ 网络辅助的拥塞控制
  + 方案1：网络路由器发送阻塞分组（choke packet）指示拥塞
  + 方案2：路由器标志或更新分组中某个字段指数拥塞

### 3.6.3 网络辅助的拥塞控制例子：ATM ABR拥塞控制

三种机制：

+ EFCI比特

+ CI和NI比特

+ ER字段设置

## 3.7 TCP拥塞控制

TCP采用端到端拥塞控制机制（IP层不向端系统提供显式的网络拥塞反馈）。TCP让每个发送方根据所感知到的网络拥塞程度来限制其向连接发送流量的速率。三个问题及方案：

+ 发送方如何限制流量发送速率：跟踪拥塞窗口（LastByteSent - LastByteAcked 《= min{cwnd,  rwnd}）

+ 发送方如何感知网络拥塞：使用确认到底来增加窗口长度及传输速率（自计时机制）

+ 发送方如何改变发送速率：调节cwnd

TCP拥塞控制算法：慢启动、拥塞避免和快速恢复

## 3.8 小结

本章学习了传输层协议向网络应用程序提供的服务：

+ UDP协议：仅向应用程序提供多路复用/分解功能，不提供不必要的服务；

+ TCP协议：向应用程序提供各种包装，如数据的可靠交付、时延保证和带宽保证；

包括下列机制：

+ 可靠数据传输机制，通过精心设计的确认、定时器、重传和序号机制完成任务。TCP协议的连接管理、流量控制、往返时间估计和可靠数据传送；
+ 拥塞控制机制及其在TCP上的应用，慢升快降；

传输层协议：

+ UDP及TCP；
+ DCCP（数据报拥塞控制协议）；
+ SCTP（流控制传输协议）；
+ TFCP（TCP友好速率控制协议）；

# 4 网络层

网络层是协议栈最复杂的部分，包括网络转发和路由选择两大功能。

## 4.1 概述

网络层的作用是将分组从一台发送主机移动到一台接收主机，需要的三种网络功能：

+ 网络转发：一个分组到达路由器的一条输入输入链路时，路由器必须将此分组移动到适当的输出链路；
+ 路由选择：当分组从发送方流向接收方时，网络层必须决定这些分组所采用的路由或路径（路由选择算法）；
+ 连接建立：要求从源到目的地沿着所选择的路径彼此握手，以便在给定源到目的地连接中的网络层数据分组能够开始流动之前建立起状态；

网络服务模型定义了分组在发送与接收端系统之间的端到端运输特性，网络层提供的服务包括：

+ 确保交付；
+ 具有时延上限的确保交付；

能够为给定源和目的地之间的分组流提供下列服务：

+ 有序分组交付；

+ 确保最小带宽；

+ 确保最大时延抖动；

+ 安全性服务；

几种服务类型：

+ 因特网尽力而为服务；

+ ATM CBR服务；

+ ATM ABR服务；

## 4.2 虚电路和数据报网络

虚电路网络：仅在网络层提供连接服务的计算机网络；

数据报网络：仅在网络层提供无连接服务的计算机网络；

### 4.2.1 虚电路网络

因特网是一个数据报网络，但是其他许多网络体系结构是虚电路网络、在网络层使用连接，这些网络层连接被称为虚电路。

一条虚电路包括三个部分：

+ 源和目的主机之间的路径（一系列链路和路由器）；

+ VC号，沿着该路径的每段链路一个号码；

+ 沿着该路径的每台路由器的转发表表项；

虚电路的三个阶段：

+ 虚电路建立；
+ 数据传送；
+ 虚电路拆除；

在虚电路网络中，该网络的路由器必须为进行中的连接维持连接状态信息。对于一个虚电路网络层，沿着两个端系统之间路径上的路由器都要参与虚电路的建立，且每个路由器都完全知道经过它的所有虚电路。

### 4.2.2 数据报网络

在数据报网络中，端系统发送分组时，为该分组加上目的端系统的地址，将分组推进网络中，无需建立任何虚电路，路由器不维护虚电路状态信息，每台路由器通过分组的目的地址来转发分组。

互联网作为一种数据报网络，将计算机连接在一起的需求发展而来。由于端系统设备复杂的多，因特网架构选择使网络层服务模型尽可能简单，另外的功能（如，按序传送、可靠数据传输、拥塞控制与DNS名字解析）在端系统的高层实现。

## 4.3 路由器工作原理

路由器的体系结构：

+ 输入端口；
+ 交换结构：
  + 内存交换；
  + 总线交换；
  + 互联网络交换；
+ 输出端口；
+ 路由选择处理器；

在输入端口和输出端口可以形成分组队列，排队的位置和程度取决于流量负载、交换结构的相对速率和线路速率。随着队列的增长，路由器的缓存空间将会耗尽，当无内存可用于存储到的第分组时将出现丢包（packet loss）。

如果输入线路速度与输出线路速度相同、交换速度快N被，在输入端口只会出现微不足道的排队；但输出端口排队可能会增长很快，足以消耗可用内存，导致分组被丢弃。输出端口的缓存大小建议 B = RTT * C / N ^ (1/2)

输出端口排队的结果是在输出端口分组调度程序（packet scheduler）要在排队的分组中选择一个分组来发送（FCFS/WFQ，加权公平排队），分组调度程序在提供服务质量保证起关键作用。

如果没有足够的内存缓存分组，需要考虑分组丢弃策略，主动队列管理（AQM算法）。随机早期检测（RED）是一种广泛研究和实现的AQM算法。

## 4.4 IP协议：因特网中的转发和编址

网络层的三个组件：

+ IP协议，包括编址规则、数据报格式和分组处理规则；
+ 路由选择协议，包括路由选择，RIP、OSPF和BGP等常用算法；
+ ICMP协议，提供差错报告和路由器信令；

### 4.4.1 数据报格式

IPv4的数据报格式：报头20Byte

IP数据报分片：

+ 链路层帧能够承载的最大数据量叫做最大传送单元（MTU）；

+ IP数据报中数据分片，用单独的链路层帧分组和发送（Fragment）；
+ TCP和UDP接收完整未分配的报文，数据报的重新组装在端系统、不在路由器；
+ IP数据报头通过标识、标志和片偏移字段表示分包和结束；

分片的开销和代价：

+ 路由器和端系统更复杂；
+ 分配可以被用于生成致命的DoS攻击；

### 4.4.2 IPv4编址

主机/路由器与链路之间的边界叫接口（interface），IP地址技术上是与一个接口相关联的。

为了确定子网，分开主机和路由器的每个端口，产生几个隔离的网络岛，使用接口端接这些隔离的网络的端点。这些隔离的网络叫做子网（subnet）。

因特网的地址分配策略被称为无类别域间路由选择（CIDR，Classless Interdomain Routing）。CIDR将子网寻址概念一般化，定义为a.b.c.d/x。通过网络前缀/子网掩码，减少在路由器中转发表的长度。这种使用单个网络前缀通过多个网络的能力成为地址聚合（address aggregation），也称为路由聚合（route agrregation）或路由摘要（route summarization）。在采用CIDR前，也采用分类编制方案（A/B/C类网络）。

特殊的IP地址，广播地址255.255.255.255.

获取地址：

+ 通过ISP或ICANN分配固定地址；

+ 通过DHCP动态分配地址：
  + DHCP服务器发现；
  + DHCP服务器提供；
  + DHCP请求；
  + DHCP ACK分配地址；

网络地址转换（NAT）使能路由器对外界隐藏家庭网络的细节，通过NAT路由器上的NAT转换表，在表项中包括了端口号及其IP地址。NAT转换表通过给内部IP地址分配端口号，通过改写该数据报的目的IP地址与目的端口号，并向家庭网络转发数据报。

NAT的缺点：

+ NAT通过附加端口号的方式违背了协议分层和端到端原则（端口号用于进程编址而不是主机编址）；

+ NAT妨碍了P2P应用程序；

通用即插即用服务（UPnP）是一种运行主机发现并配置临近NAT的协议，要求主机和NAT都是UPnP兼容的。通过UPnP，在主机上运行的应用程序能够为某些请求的公共端口号请求一个NAT映射，该映射位于（专用IP地址，专用端口号）和（公共IP地址，公共端口号）之间。UPnP允许外部主机使用TCP或UDP向NAT化的主机发起通信会话，提供了有效和健壮的NAT穿越解决方案。

### 4.4.3 因特网控制报文协议（ICMP）

ICMP是主机和路由器用例沟通网络层的信息，ICMP报文承载于IP分组上。

+ 差错报文；

+ 源抑制报文；

### 4.4.4 IPv6

IPv6数据报格式：报头20Byte。

IPv4到IPv6的迁移：

+ 双栈方案；
+ 隧道方案；

### 4.4.5 IP的安全性

IPv4的设计是在因特网用于相互信任的联网研究人员之间的时代，基本未考虑安全性。安全服务的信息网络协议，IPSec是一个主要的安全网络层协议，也在虚拟专用网（VPN）中得到广泛部署。

IPSec会话提供的服务包括：

+ 密码技术约定；
+ IP数据报有效载荷的加密；
+ 数据完整性；
+ 初始鉴别；

## 4.5 路由选择算法

路由选择算法：给定一组路由器及连接路由器的链路，找到一条从源路由器到目的路由器的好的路径：

+ 全局式路由选择算法 vs 分布式路由选择算法；

+ 静态路由选择算法 vs 动态路由选择算法；

+ 负载敏感算法 vs 负载迟钝算法；

### 4.5.1 链路状态路由选择算法

在链路状态算法（LS）中，网络拓扑和链路费用已知（通过链路状态广播获取），通过链路状态路由选择算法（Dijkstra）从某节点迭代计算该节点到网络中所有其他节点的最低费用路由。

LS算法是一种全局化的路由选择算法，由一个初始化步骤和其后的循环（次数与网络中节点个数相同）组成。一旦终止，就计算出从源节点到网络中每个其他节点的最短路径。算法复杂性为O（n^2）。

问题和缺陷：拥塞敏感的路由选择振荡问题。一种解决方案是避免所有的路由器同时运行LS算法，让每台路由器发送链路通告的时间随机化。

### 4.5.2 距离向量路由选择算法

距离矢量算法（DV）是一种迭代、异步的分布式算法。在DV算法中，当节点x发现直接相连的链路费用发生变化或从某个邻居接收一个距离向量的更新时，就重新计算路由选择表项，然后将计算结果分发给邻居，该过程一直要持续到邻居间没有更多信息要交换为止。

问题：链路费用改变与链路故障，导致需要多次迭代才能重新收敛。一种解决方案是增加毒性逆转，该方案不能解决3个或更多节点的环路问题。

LS与DV算法的对比：

+ 报文复杂性：
  + LS：要求每个阶段都知道每条链路的费用，要发生O（N*E）个报文，而且每次链路费用变化是，必须向所有节点发送报文；
  + DV：只有新的链路费用导致与该链路相连节点的最低费用路径发生改变时才发送改变的链路费用报文；

+ 收敛速度：
  + LS：O（N^2)算法；
  + DV：收敛较慢，且可能会遇到路由选择环路和无穷计数问题；

+ 健壮性：
  + LS：路由计算在某种程度上是分离的，提供了一定程度的兼庄乡；
  + DV：节点计算不准确会扩散到整个网络；

### 4.5.3 层次路由选择算法

自治系统（AS）：一组处在相同管理控制下的路由器组成，运行同样的路由选择算法，并且拥有彼此的信息：

+ 自治系统内路由选择协议：RIP和OSPF；
+ 自治系统间路由选择协议：BGP；

## 4.6 因特网中的路由选择

### 4.6.1 RIP

AS内部路由选择协议又称为内部网关协议，包括路由选择协议（RIP）和开放最短路径协议（OSPF）。

RIP是一种距离向量协议：

+ RIP以跳数（从源路由器到目的子网的最短路径经过的子网数量）为路由费用，一条路径的最大费用被限定为15，因此RIP的使用限制在网络直径不超过15跳的自治系统内；
+ 每台路由器维护一张路由选择表（routing table），包括该路由器的距离向量和转发表；
+ 路由选择更新信息通过RIP响应报文（封装在UDP报文段中）来交换，一般30秒内相互交换一次；
+ 路由选择表根据RIP响应报文信息更新表项中的最短路径连接，并向相邻路由器发送通过来传播该信息；

### 4.6.2 OSPF

OSPF路由协议广泛用于AS内部路由选择：RIP通常用于下层ISP和企业网中，OSPF及IS-IS通常用于上层的ISP中。

OSPF的核心是一个使用泛洪链路状态信息的链路状态协议和一个Dijkstra最低费用路径算法。通过使用OSPF，路由器构建了一幅关于整个自治系统的完整拓扑；路由器在本地运行Dijkstra的最短路径算法，以确定一个以自身为根节点的到所有子网的最短路径树。

OSPF路由器向自治系统内所有其他路由器广播路由选择信息。OSPF协议实现诸如可靠报文传输、链路状态广播等功能，还要检查链路正在运行，并获取相邻路由器的网络范围链路状态数据库。通过链路状态通告的周期性更新（至少30分钟一次）增加了链路状态算法的健壮性。

OSPF的优点：

+ 安全：支持OSPF报文鉴别机制，防止恶意入侵者将不正确的信息注入路由器表内；
+ 允许使用多条相同费用的路径；
+ 对单播路由和多播路由的综合支持；
+ 支持者单个路由选择域内的层次结构；

### 4.6.3 BGP

边界网关协议（BGP）是跨越多个AS的源和目的对之间如何确定路径。BGP为每个AS提供下列信息：

+ 从相邻AS处获得子网可达性信息；
+ 向本AS内部的所有路由器传播这些可达性信息；
+ 基于可达性信息和AS策略，决定到达子网的好路由。

BGP使得每个子网向因特网的其他部分通告存在，并确保在因特网中的所有AS知道该子网及如何到达。

BGP路由器通过使用179端口的半永久TCP连接来交换路由选择信息。在BGP中，一个AS由全局唯一的ASN标识（由ICANN地区注册机构分配）。概念：

+ BGP对等方；
+ BGP会话；
+ eBGP和iBGP；

BGP路径属性：

+ origin属性：描述路由通过何种方式注入到BGP路由表中，包括IGP和Incomplete；
+ AS-PATH：描述该路由经过AS组成的路径。通过AS-Path属性，可以避免环路；
+ NEXT-HOP：指示下一个AS的路由器入口网段；

BGP路由选择：BGP使用eBGP和iBGP向AS中所有路由器发布路由。进入路由选择进程的蔬菜是被路由器知道并接受的所有路由的集合。

为什么会有不同的AS间和AS内部路由选择协议：

+ 策略：AS间策略是主要因素，AS内权重不大；
+ 规模：AS间可扩展性是关键要素，AS内权重不大；
+ 性能：AS间路由选择是面向策略，质量/性能是次要关心，AS内性能考虑更多；

## 4.7 广播和多播路由选择

广播路由选择（broadcast routing）：网络层提供了一种从源节点到网络中所有其他节点交付分组的服务；

多播路由选择（multi-cast routing）：单个源节点向其他网络节点的一个子集发送分组的副本。

### 4.7.1 广播

 N次单播方案

无控制泛洪：

+ 源节点向所有邻居发送分组副本；
+ 优点是方案简单而优雅；
+ 缺点是无休止循环或广播风暴；

受控泛洪：

+ 序号控制泛洪：源节点将地址及广播序号放入广播分组，接收节点检查是否在节点维护列表中，如果在则放弃分组，如果不在则向邻居转发；
+ 反向路径转发（RPF/RPB）：路由器接收到具有给定源地址的广播分组时，只有该分组到达链路是返回原节点的最短单播路径上，才向所有出链路传输报文，否则丢弃；

生成树广播：

+ 首先对网络节点构造最小生成树，源节点向所有属于该生成树的特定链路发送分组；
+ 接受广播分组的节点向生成树的所有邻居转发分组；

实践中的广播算法：

+ 范围受限的泛洪算法（Gnutella泛洪机制）；
+ 序号控制泛洪机制（LSA）；

### 4.7.2 多播

多播分组仅被交付给一组接受方。应用包括批量数据传送、流式连续媒体、数据共享应用、数据供给、Web缓存更新和交互式游戏。

多播面临的问题：

+ 怎样标识多播分组的接收方；
+ 怎样为发送到接收方的分组编址（D类地址和多播组）；

因特网组管理协议（IGMP）运行在一台主机与其直接相连的路由器之间，包括IGMP报文和多播路由选择协议两个组件：

+ IGMP报文包括：membership_query、membership_report和leave_group；
+ 多播路由算法包括基于有源树和共享树两组；

## 4.8 小结

为了满足性能要求，路由器采用数据报网络层而不是虚电路网络层，使用流水线和固定长度的报头、取消分配和提供尽力而为的服务；不跟踪各流分组，使路由选择决策只依赖于数据报中层次结构化的目的地址。

路由选择算法把计算机网络抽象为一个具有节点和链路的图：

+ 集中式（全局）方法：每个节点的的网络的一张完整并独立应用一种最短路径路由选择算法；
+ 分布式方法：各节点只有整个网络的部分知识，节点在一起工作以便沿最短路径交付分组；
+ 层次化方法：通过把大型网络划分为自治系统（AS）的独立管理域来解决规模问题。

# 5 链路层：链路、接入层和局域网

链路层讲述分组如何通过构成端到端通信路径的各段链路，包括数据报如何封装进链路层帧、不同链路协议、编址和传输碰撞等。

## 5.1 链路层概述

节点：运行链路层协议的设备，包括主机、路由器、交换机和WIFI接入点；

链路：沿通信路径连接相邻节点的通信信道。

### 5.1.1 链路层提供的服务

+ 成帧（Framing）：帧由帧头和数据字段组成，IP包封装在数据字段中；
+ 链路接入：媒体访问控制（MAC）规定了帧中链路上传输的规则；
+ 可靠交付：差错控制和纠错，通常应用于高差错率链路；
+ 差错检测和纠正：链路层的差错检测通常更复杂，并用硬件实现；

### 5.1.2 链路层在何处实现

链路层的主体部分在网络适配器（network adapter，又叫NIC）中实现，核心是链路层控制器，该控制器通常是一个实现了多项链路层服务（成帧、链路接入、差错检测等）的专用芯片；部分链路层功能是由软件组件实现，如组装链路层寻址信息和激活控制器硬件等。

## 5.2 差错检测和纠正技术

传输数据中检测差错的3中技术：

+ 奇偶校验：描述差错检测和纠正的基本思想；
+ 检验和方法：更多应用与传输层；
+ 循环冗余检测：更多应用在适配器中的链路层；

## 5.3 多路访问链路和协议

两种类型的网络链路：

+ 点对点链路；
+ 广播链路；

多路访问问题：如何协调多个发送和接受节点对一个共享广播信道的访问。

多路访问协议：

+ 信道划分协议；
+ 随机接入协议；
+ 轮流协议；

理想多路访问协议应具有的特性：

+ 当仅有一个节点要发送数据时，该节点具有Rbps的吞吐量；
+ 当有M个节点要发送数据时，每个节点吞吐量为R/Mbps；
+ 协议是分散的；
+ 协议是简单的；

### 5.3.1 信道划分协议

+ TDM

+ FDM

+ CDMA

### 5.3.2 随机接入协议

+ 时隙ALOHA
+ ALOHA
+ CSMA
+ CSMA/CD

## 5.4 交换局域网

交换局域网：交换机运行在链路层，通过链路层地址而不是IP地址来转发链路层帧通过交换机网络。

### 5.4.1 链路层寻址和ARP

MAC地址：链路层地址，长度为6B，有2^48个可能的地址。IEEE管理MAC地址空间，每个公司购买2^24个地址空间块。

为了使网络体系结构中各层次成为独立的构建模块，各层有自己的寻址方案。应用层（主机）、传输层（进程/端口）、网络层（IP地址）和链路层（MAC地址）。MAC地址的作用：

+ 局域网为任意网络层协议设计，而不仅是IP和因特网。适配器采用MAC地址便于支持多网络协议；
+ 适配器如不采用MAC地址而采用IP地址的话，必须存储在适配器的RAM中，每次加电重新配置；
+ 适配器如不采用MAC地址而用IP数据报寻址，将被接收到的每个帧中断；

地址解析协议（ARP）：实现网络层地址和链路层地址的转换。主机或路由器在内存中有ARP表，包括IP地址、MAC地址和TTL。ARP查询分组（广播帧）和响应分组（标准帧），ARP是跨越链路层和网络层边界的协议。

### 5.4.2 以太网

以太网拓扑结构发展：总线结构->星形结构，集线器（hub）和交换机（switch）担任中心交换点。

以太网帧结构：前同步码-目的地址-源地址-类型-数据-CRC校验和。

以太网技术协议。

### 5.4.3 链路层交换机

交换机的任务是接收入链路层帧并将它们转发到出链路。交换机对子网中的主机和路由器是透明的。

交换机转发和过滤：

+ 过滤决定一个帧应该转发到某个接口还是将其丢弃；
+ 转发决定一个真应该被导向那个接口、并将该帧移动到那个接口；

交换机是自学习的、即插即用的设备，不需要网络管理员或用户的干预。

链路层交换机的特色和性质：

+ 消除碰撞；
+ 异质链路；
+ 网络管理；

交换机与路由器的比较：工作在层二or层三的分组交换机。集线器、路由器和交换机三设备对比三个要素：

+ 流量隔离；
+ 即插即用；
+ 优化路由；

### 5.4.4 虚拟局域网

基于交换机等级结构的局域网三个确定：

+ 缺乏流量隔离；
+ 交换机的无效使用；
+ 难以管理用户在不同组的移动；

VLAN（虚拟局域网）：基于一个单一的物理局域网基础设施定义多个虚拟局域网，在一个基于端口的VLAN中交换机端口（接口）由网络管理员划分为足，每个组构成一个VLAN，在每个VLAN的端口形成一个广播域。

### 5.4.5 链路虚拟化：网络作为链路层

链路：连接两台或多条主机的链路层信道，可以是单一局域网网段，也可以是地理上分布的交换局域网或通过VLAN与其他局域网主机进行连接。

MPLS：多协议标签交换网络，基于分组的虚电路网络，作为为IP设备互联服务的链路层技术。

# 6 无线网络和移动网络

无线网络与有线网络之间的差异性：

+ 通信链路的无线特性所带来的挑战；
+ 由无线链路使能的移动性；

## 6.1 概述

无线网络要素：

+ 无线主机：运行应用程序的端系统设备，可以是便携机、智能手机或桌面计算机，可能移动，也可能不移动；
+ 无线链路：两个关键特征是覆盖区域和链路速率；
+ 网络基础设施：
  + 基站/无线接入点；
  + 切换；
  

四种基础设施模式：
 + 单跳，基于基础设施：WLAN、移动蜂窝网络；
 + 单跳，无基础设施：蓝牙及具有自组织模式的802.11网络；
 + 多跳，基于基础设施：无线网状网络；
 + 多跳，无基础设施：移动自组织网络（MANET）；

## 6.2 无线链路和网络特征

无线链路与有线链路的差别：

+ 递减的信号强度：路径损耗和衰减；
+ 来自其他源的干扰；
+ 多径传播；

物理层的特征：

+ 对于给定的调制方案，SNR越高、BER越低；
+ 对于给定的SNR，具有较高比特传输率的调制技术将具有较高的BER；
+ 物理层调制技术的动态选择能用于食品对信道条件的调制技术；

## 6.3 WiFi： 802.11 无线LAN

IEEE 802.11标准：

+ 802.11b： 2.4～2.4835GHz，最高速率11Mbps；
+ 802.11a： 5.1～5.8GHz，最高速率54Mbps；
+ 802.11g： 2.4～2.485GHz，最高速率54Mbps；
+ 802.11n：采用MIMOjish，速率可达数百Mbps；

### 6.3.1 802.11体系结构

基本服务集（BSS，Basic Service Set）：包含一个接入点（AP）和若干个无线站点；

服务集标识（SSID，Service Set Identifier）：

# 7 多媒体网络

## 7.1 多媒体网络应用

多媒体网络应用：任何应用音频或视频的网络应用，本节提供多媒体应用的分类法，

视频特点：

+ 高比特率
+ 可以被压缩，在视频质量与比特率见进行折中

音频特点：

+ 带宽需求低于视频

+ 用户对音频小失误的敏感度更高

多媒体应用分类：

+ 流式存储音频和视频：最主要的性能是平均吞吐量
  + 流（Streaming）：开始接收文件后就可以播放，避免完整下载才能播放
  + 相互作用：用户组播放过程中可以进行暂停、快进等操作
  + 连续播放：开始播放后应根据初始记录的时序进行
+ 会话式IP语音和视频
  + 时延敏感
  + 容忍丢包差
+ 流式实况音频和视频

## 7.2 流式存储视频



## 7.3 IP语音



## 7.4 实时会话式应用的协议



## 7.5 支持多媒体的网络



## 7.6 小结



# 8 计算机网络中的安全

## 8.1 什么是网络安全

安全通信（secure communication）的特性：

+ 机密性（confidentiality）
+ 完整性（message integrity）
+ 端点鉴别（end-point authentication）
+ 运行安全（operational security）

面临威胁：

+ 窃听
+ 修改、插入或删除报文内容

## 8.2 密码学的原则

名词定义：

+ 明文（plaintext）
+ 密文（ciphertext）
+ 加密算法（encryption algorithm）
+ 解密算法（decryption algorithm）
+ 密钥（key）

### 8.2.1 对称密钥密码体制

古典密码机制：

+ 凯撒密码
+ 单码替代密码
+ 多码替代密码

密码攻击：

+ 唯密文攻击
+ 已知明文攻击
+ 选择明文攻击

块密码（block ciphers）：

+ 通常采用函数模拟随机排列表
+ DES、3DES和AES
+ 密码块链接技术

### 8.2.2 公开密钥加密



## 8.3 报文完整性和数字签名



## 8.4 端点鉴别



## 8.5 安全电子邮件



## 8.6 使TCP连接安全：SSL

安全套接字层（SSL）或运输层安全性（TLS）通过采用机密性、数据完整性、服务器鉴别和客户鉴别来强化TCP，通常用来为发生在HTTP之上的事物提供安全性。

### 8.6.1 宏观描述

三个阶段：

+ 握手
  + 创建TCP连接
  + 验证服务节点合法
  + 发送主密钥，生成会话密钥
+ 密钥导出（4个密钥（Eb，Mb，Ea和Ma））
  + Eb用于请求端到服务端的会话加密密钥
  + Mb用于请求端到服务端的会话MAC密钥
  + Ea用于服务端到请求端的会话加密密钥
  + Ma用于请求端到服务端的会话MAC密钥
+ 数据传输
  + 将数据流分割为记录，每个记录附加MAC，并加密该记录+MAC
  + 接受端恢复记录，并检查MAC
  + SSL通过序号阻止重放攻击

### 8.6.2 更完整的描述

SSL握手：

+ 请求端发生支持的密码算法列表，连同一个随机数
+ 服务端选择加密算法（对称算法、公钥算法和MAC算法），把算法、证书和服务器随机数返回请求端；
+ 请求端验证证书，提取服务端的公钥，生成一个前主密钥（PMS），用服务端点公钥加密PMS，并发给服务器；
+ 使用相同的密钥导出函数，请求端和服务端独立从PMS和随机数中计算主密钥（MS），主密钥被切片生成两个密码和两个MAC密钥（在CBC模式还包括IV）；
+ 请求端发送所有握手报文的一个MAC；

+ 服务端发送所有握手报文的一个MAC；

连接关闭：

+ 通过SSL序号和随机数防止重放攻击；
+ 在报文的类型字段支持该记录是否用于终止该SSL会话；

## 8.7 网络层安全性：IPSec和虚拟专用网

IPSec为任意两个网络层实体（包括主机和路由器）之间的IP数据报提供了安全服务机制，包括机密性、源鉴别、数据完整性和重放攻击防护。

### 8.7.1 IPSec和VPN

PN（专用网络，Private Network）：为特定机构专业的分立网络，需要购买、安装和维护独立的物理网络基础设施；

VPN（虚拟专用网络，Virtual Private Network）：基于公共因特网设施基础上运行的虚拟专用网络，办公室之间的流量在进入公共因特网之前进行加密；

### 8.7.2 AH协议和ESP协议

两个重要文档：

+ RFC4301：总体IP安全体系结构；
+ RFC6701：IPSec协议集；

两个主要协议：

+ AH（鉴别头部，Authentication Header）协议：源鉴别和数据完整性服务；
+ ESP（封装安全性载荷，Encapsulation Security Payload）协议：源鉴别、数据完整性和机密性服务；

### 8.7.3 安全关联



### 8.7.4 IPSec数据报



### 8.7.5 IKE: IPSec中的密钥管理



## 8.8 使无线LAN更安全

### 8.8.1 有线等效保密

有线等效保密（WEP， Wired Equivalent Privacy），802.11规范中标准化的安全性机制，为在主机和无线接入点（基站）提供鉴别和数据的加密。WEP提供了一种相对弱的加密、仅有单一方式执行鉴别并且没有密钥分发机制。

鉴别机制：

+ 无线主机通过接入点请求鉴别；
+ 接入点以一个128字节的不重数字响应该鉴别请求；
+ 无线主机用其与接入点共享的密钥加密这个不重数值；
+ 接入点解密主机加密的不重数值；

加密机制：

+ 主机与基站共用一个40bit的密钥Ks；
+ 每帧用一个24bit的初始向量IV，Ks + IV组成64bit的密钥，逐帧加密；
+ IV每帧变化，在帧头明文传给接收方；

问题：

+ IV只有24bit，密钥空间只有2^24个；
+ IV在帧头明文传输，容易被窃听；

### 8.8.2 IEEE 802.11i

802.11i提供了强得多的加密形式、一种可扩展的鉴别机制集合以及一种密钥分发机制。

除了无线客户和接入点外，802.11i定义了一台鉴别服务器。鉴别服务器与AP的分离式使得一台鉴别服务器服务于多个AP，降低了AP的成本和复杂性。

802.11i的四个阶段：

+ 发现
  + AP通告存在及其可以向无线客户节点提供的鉴别和加密形式；
  + 客户则请求希望的特定鉴别和加密形式；
+ 互相鉴别和主密钥（MK）生成
  + 鉴别发生在无线客户和鉴别服务器之间，接入点起中继作用；
  + 可扩展鉴别协议（EAP）定义了客户和鉴别服务器之间交互的端到端报文格式；
  + EAP-TLS是哟个公钥技术，允许客户和鉴别服务器互相鉴别，并导出为双方所知道一个主密钥；

+ 成对主密钥（PMK）生成
  + MK是仅为客户和鉴别服务器的共享密钥；
  + MK生成PMK，作为客户和AP共享的密钥；

+ 临时密钥（TK）生成
  + 使用PMK，无线客户和AP生成附加大、用于通信的密钥；
  + 临时密钥TK用于执行经无线链路向远处主机发送数据的链路级加密；

## 8.9 运行安全性：防火墙和入侵检测系统

### 8.9.1 防火墙

防火墙（firewall）是一个硬件和软件的结合体，将机构内部网络与整个因特网隔离开，允许一些数据分组通过而阻止另一些分组通过。

防火墙的三个目标：

+ 内外部流量通过防火墙；
+ 仅被授权的流量（由本地安全策略定义）运行通过；
+ 防火墙自身免于渗透；

防火墙的三种类型：

+ 传统分组过滤器；
+ 状态过滤器；
+ 应用程序网关；

### 8.9.2 入侵检测系统

入侵检测系统（IDS，Intrusion Detection System）：观察到潜在恶意流量时能产生告警的设备，分为基于特征的系统和基于异常的系统；

入侵防止系统（IPS，Intrusion Prevention System）：滤除可疑流量的设备；